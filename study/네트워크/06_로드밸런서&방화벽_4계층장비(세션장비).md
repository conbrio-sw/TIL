# 로드 밸런서 / 방화벽

## 6.1 4계층 장비의 특징

- TCP와 같은 4계층 헤더에 있는 정보를 이해하고 이 정보를 기반으로 동작
  - 4계층 프로토콜 동작에 대한 깊은 이해 없이, 4 계층 장비를 2, 3계층 네트워크 장비처럼 설계, 운용하면 여러가지 문제 발생
  - 기존 네트워크와 다른 점
    - 세션 테이블과 그 안에 있는 세션 정보가 가장 중요
      - 그래서 4계층 장비 = 세션 장비라고 부르기도 한다
- 세션 테이블
  - 세션 정보를 저장, 확인하는 작업 전반에 대한 이해 필요
  - 세션 정보는 세션 테이블에 남아 있는 라이프타임이 존재, 이 부분에 대한 고려 필요
  - Symmetric(대칭) 경로 요구
    - Inbound와 Outbound 경로가 일치해야한다
  - 정보 변경 (로드 밸런서의 경우)
    - IP 주소가 변경되어 확장된 L7 로드밸런서 (ADC)는 애플리케이션 프로토콜 정보도 변경된다.

##  6.2 로드 밸런서

- 서버나 장비의 부하를 분산하기 위해 사용하는 장비
  - 트래픽을 분배해주는 기능 때문
  - 4계층 이상에서 동작하면서, IP 주소 / 4계층 정보 / 애플리케이션 정보를 확인, 수정하는 기능이 있다.
  - 웹 서버의 부하 분산에 가장 많이 이용
    - 내부 부품을 이중화하거나, 용량이 더 큰 부품을 사용하면 가격이 크게 올라간다
    - 작은 장비를 여러 대로 묶어 사용하는 방법을 선호
      - 스케일 아웃이라고 부른다
- 작은 시스템 여러대 운영하더라도 사용자는 서버 배치와 상관 없이 하나의 서비스로 보여야한다.
  - 로드 밸런서가 서비스에 사용되는 대표 IP 주소를 서비스 IP로 갖고
  - 그 밑에 시스템이 늘어나면 로드 밸런서가 각 시스템의 실제 IP로 변경해 요청을 보낸다.
- 계층에 따라 2개
  - L4 로드 밸런싱
    - 일반적인 로드밸런서가 동작하는 방식
    - TCP, UDP 정보(특히 포트 넘버)를 기반으로 로브 밸런싱 수행
    - 최근에는 L4, L7 기능을 모두 지원하기 때문에 L4만 수행하는 전용장비는 찾기 어렵다
      - L7 지원 여부와 상관없이 4계층에 대한 정보로만 분산 처리하는 경우를 L4 로드 밸런싱이라고 한다
  - L7 로드 밸런싱
    - HTTP, FTP, SMTP와 같은 애플리케이션 프로토콜 정보를 기반으로 로드밸런싱 수행
    - HTTP 헤더 정보나 URI와 같은 정보를 기반으로 프로토콜 이해한 후, 부하를 분산
    - ADC(Application Delivery Controller)라고 부른다.

### 6.2.1 L4 스위치

- 내부 동작은 4계층 로드 밸런서이지만 외형은 스위치처럼 여러 개의 포트를 가지고 있다.

- 부하 분산, 성능 최적화, 리다이렉션 기능을 제공한다.

  ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/195.jpg)

- 가상 서버, 가상 IP, 리얼 서버와 리얼 IP를 설정해야한다.
  - 가상 서버는 사용자가 바라보는 실제 서비스 이고 가상 IP는 사용자가 접근해야하는 서비스 IP
  - 리얼 서버는 실제 서비스를 수행하는 서버, 리얼 IP는 리얼 서버의 IP
  - L4 스위치는 가상 IP를 리얼 IP로 변경해주는 역할

### 6.2.2 ADC

- 애플리케이션 계층에서 동작하는 로드 밸런서
  - 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작하므로
  - 다양한 부하 분산, 정보 수정, 정보 필터링이 가능
    - 이런 상세한 동작을 위해 프락시로 동작
- ADC는 일부 소프트웨어 ADC를 제외하면 L4 스위치의 기능을 포함
  - 4계층에서 애플리케이션 계층까지 로드 밸런싱 기능을 제공
  - 페일 오버 (Failover : 장애극복 기능), 리다이렉션 기능도 함께 수행
  - 캐싱, 압축, 콘텐츠 변환 및 제작성, 인코딩 변환 등이 가능하고 애플리케이션 프로토콜 최적화 기능도 제공
  - 플러그인 형태로 보안 강화 기능을 추가로 제공해 WAF(Web Application Firewall) 기능이나 HTML, XML 검증과 변환을 수행할 수 있습니다.

### 6.2.3 L4 스위치 vs ADC

- L4 스위치
  - TCP, UDP 기반으로 부하 분산
  - TCP 계층 최적화와 보안 기능 함께 제공
  - TCP 레벨의 간단한 DoS(Denial of Service) 공격을 방어하거나 서버 부하를 줄이기 위해 TCP 세션 재사용과 같이 보안과 성능을 높여주는 기능도 함께 제공
  - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/196.jpg)

- ADC
  - 애플리케이션 프로토콜을 이해하고 애플리케이션 내용에 대한 분산, 리다이렉션, 최적화를 제공해 L4 스위치보다 더 다양한 기능을 사용 가능
  - 성능 최적화를 위해 서버에서 수행하는 작업 중 부하가 많이 걸리는 작업을 별도로 수행
    - 이미지나 정적 콘텐츠 캐싱(Caching) 기능
  - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/196_2.jpg)
    - 웹 서버에는 콘텐츠 압축 기능이 있지만 ADC에서 이 역할을 수행해 웹 서버의 부하 줄이기 가능
    - 하드웨어 가속이나 소프트웨어 최적화를 통해 이런 부하가 걸리는 작업을 최적화하는 기능 보유
  - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/197.jpg)
  - 최근 SSL 프로토콜 사용하는 비중이 늘면서 웹 서버에 SSL 암복호화 부하가 늘고 있다.
    - 개인 정보 보호를 위해 개인정보가 전달되는 일부 페이지에서만 SSL을 사용했지만 보안 강화를 위해 웹사이트 전체를 SSL로 처리하는 추세
    - ADC에서는 SSL의 앤드 포인트로 동작해 클라이언트에서 ADC까지의 구간을 SSL로 처리해주고 ADC와 일반 웹 서버 사이를 일반 HTTP를 이용해 통신
    - 이런 기능을 사용할 때는 웹 서버 여러 대의 SSL 통신을 하나의 ADC에서 수용하기 위해 ADC에 전용 SSL 가속 카드를 내장
  - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/197_2.jpg)

### 스케일 업과 스케일 아웃

![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/198_2.jpg)

|      | 스케일 업(Scale-Up)                                          | 스케일 아웃(Scale-Out)                                       |
| ---- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 설명 | 하드웨어 성능 자체를 업그레이드하거나 더 높은 성능의 시스템으로 마이그레이션하는 방법 | 여러 대의 서버로 로드를 분산하는 방법. 서비스 자체를 구분해 나누거나 같은 서비스를 분산해 처리하는 방법이 있다. |
| 장점 | 부품을 쉽게 추가할 수 있으면 시스템 설계 변경 없이 서비스 사용량을 쉽게 늘릴 수 있다(주로 기존 대형 유닉스 시스템에서 사용함) | 스케일 업 방식보다 더 적은 비용으로 시스템 확장이 가능하다.여러 대의 시스템에 로드를 적절히 분산해 하나의 시스템에 장애가 발생하더라도 서비스에 미치는 영향이 없도록 결함허용(Fault Tolerance)을 구현할 수 있다. |
| 단점 | 부품 추가가 어렵다(최근 x86), 시스템이 커질수록 비용이 기하급수적으로 증가한다. | 스케일 아웃을 위해 별도의 복잡한 아키텍처를 이해하고 운영해야만 할 수 있다. 프로세스나 네트워크 장비가 추가로 필요할 수 있다. |

## 6.3 방화벽

- 네트워크 중간에 위치해 해당 장비를 통과하는 트래픽을 사전에 주어진 정책 조건에 맞추어 허용하거나 차단하는 장비
- 일반적으로 네트워크 3, 4 계층에서 동작하고 세션을 인지, 관리하는 SPI(Stateful Packet Inspection) 엔진을 기반으로 동작하는 장비
- ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/200.jpg)
- 방화벽은 NAT(Natework Address Translation) 동작 방식과 유사하게 세션 정보를 장비 내부에 저장
  - 패킷이 외부로 나갈 때 세션 정보를 저장하고, 패킷이 들어오거나 나갈 때 저장했던 세션 정보를 먼저 참조해 들어오는 패킷이 외부에서 처음 시작된 것인지, 내부 사용자가 외부로 요청한 응답인지 가려낸다.
  - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/200_2.jpg)
- 세션 테이블과 같은 상태 정보를 담아두는 공간이 없으면?
  - 세션의 방향성 파악하지 못하고, 많은 정책을 복잡하게 관리해야한다
  - 방화벽에서는 하나의 정책을 설정하기 위해 최소한 두 개의 양방향 정책이 함게 설정
    - 인터넷과 같은 불특정 다수와 통신할 때 정책의 복잡도가 크게 증가
  - 인터넷 방화벽에서의 기본 정책
    - 나가는 모든 패킷을 허용, 들어오는 모든 패킷을 차단하는 것
  - 상태 테이블이라고 부르기도 한다.

## 6.4 4계층 장비를 통과할 때의 유의점 (세션관리)

- 세션 장비는 일반적인 2, 3계층 네트워크 장비와 달리 세션을 이해하고 세션 테이블을 유지
  - 세션 테이블 정보를 이용해 패킷을 변경하거나 애플리케이션 성능을 최적화하고 보안을 강화하기 위해
  - 패킷을 포워드(Forward)하거나 드롭(Drop) 가능
  - 이런 기능을 충분히 활용하기 위해서는
    - 애플리케이션과 세션 장비 간 세션 정보를 동일하게 유지
    - 애플리케이션을 제작할 때 네트워크 중간에 있는 세션 장비를 고려해 여러 가지 기능을 추가
    - 애플리케이션의 세션 시간과 서비스 방향성을 고려하고 비대칭 경로를 피하는 것이 매우 중요

### 6.4.1 세션 테이블 유지, 세션 정보 동기화

- 종단 장비에서 통신을 시작하면 중간에 있는 세션 장비는 해당 세션 상태를 테이블에 기록
  - 통신이 없더라도 종단 장비 간 통신이 정상적으로 종료되지 않았다면 일정 시간 동안 세션 테이블을 유지
  - 세션 테이블은 메모리에 저장되므로 메모리 사용률을 적절히 유지하기 위해 일정 시간만 세션 정보를 저장
  - 악의적인 공격자가 과도한 세션을 발생시켜 정상적인 세션 테이블 생성을 방해하는 세션 공격으로부터 시스템을 보호하기 위해 타임아웃값을 더 줄임
  - 결론
    - 세션 장비는 세션 정보를 무제한으로 저장할 수 없고 
    - 여러 가지 애플리케이션 통신을 관리하므로 일반적인 애플리케이션에 맞추어 적당한 세션 타임아웃값을 유지
- 일부 애플리케이션은 세션을 한 번 연결해놓고 다음 통신이 시도될 때까지 세션이 끊기지 않도록 세션 타임아웃값을 길게 설정
  - 통신할 때, 세션 장비의 세션 타임아웃값이 애플리케이션의 세션 타임아웃값보다 짧으면 통신에 문제
  - 중간 세션 장비의 세션 유지 시간이 지나 세션 테이블에 있는 세션 정보가 사라졌지만
  - 양쪽 단말에서는 세션이 유지되고 있다면 다시 통신이 시작되어 데이터를 보낼 때 중간 세션 장비에서 막히는 문제가 발생
    - 세션 장비의 세션 테이블에 세션이 없는 상황에서
    -  SYN이 아닌 ACK로 표시된 패킷이 들어오면 세션 장비에서는 비정상 통신으로 판단해 패킷을 차단
    - 만약 그런 종류의 패킷을 통과시키는 옵션을 설정해 패킷을 강제로 통과시키더라도 반대 방향으로 데이터가 들어오면 정책에 막힐 수 있다.
  - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/202-164747059133810.jpg)

#### 세션 장비 운영자 입장

- 세션 만료 시간 증가
  - 세션 장비 운영자가 애플리케이션에 맞게 세션 만료 시간을 늘리는 방법 
  - 이 경우, 애플리케이션의 세션 유지 시간보다 방화벽 세션 유지 시간이 길어야 합니다. 
  - 대부분의 세션 장비는 포트 번호나 IP 주소마다 별도의 세션 만료 시간을 설정할 수 있어 전체 세션 유지 시간이 길어져 시스템 메모리가 고갈되는 문제를 예방할 수 있습니다.
  -  하지만 세션 장비 운영자가 정확한 정보를 얻어 설정할 수 있도록 애플리케이션측 개발자나 관리자가 애플리케이션 고유의 세션 유지 시간을 미리 알려주어야 합니다
- 세션 시간을 둔 채로 중간 패킷을 수용할 수 있도록 방화벽 설정(세션 장비 중 방화벽에 해당)
  - 세션 테이블에 정보가 없는 ACK 패킷이 방화벽에 들어오면 방화벽은 패킷을 차단하지만 
  - 방화벽 옵션을 조정해 세션 테이블에 정보가 없는 ACK 패킷이 들어오더라도 세션을 새로 만들어 통과시킬 수 있는 옵션이 있다.
  - 하지만 이런 해결책은 전체적인 보안이 취약해지는 기능이므로 여러 가지 고려가 필요하고 가능하면 적용X
- 세션 장비에서 세션 타임아웃 시 양 단말에 세션 종료 통보
  - 양 종단 장비의 세션 정보와 중간 세션 장비의 세션 정보가 일치하지 않아 발생하는 문제를 해결하기 위해 사용하는 기능
  - 세션 상태 정보를 강제로 공유하기 위해 세션 장비에서는 세션 타임아웃 시 세션 정보를 삭제하는 것이 아니라 세선 정보에 있는 양 종단 장비에 세션 정보 만료(RST)를 통보
  - TCP의 RST 플래그를 1로 세팅해 양 종단 장비에 전송하면(A를 출발지로 B를 도착지로, B를 출발지로 A를 도착지로) 양 종단 장비에서는 세션이 비정상적으로 종료된 것으로 판단해 해당 세션을 끊음
  - 애플리케이션에서 통신이 필요하면 새로운 세션을 맺어 통신
  - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/204.jpg)

#### 개발자 입장

- 애플리케이션에서 주기적인 패킷 발생 기능 추가
  - 애플리케이션과 세션 장비의 세션 타임아웃 시간을 일치시키는 가장 좋은 방법
    -  애플리케이션에서 패킷을 주기적으로 발생시키는 것입니다. 
  - 애플리케이션 개발 시 중간에 통신이 없더라도 
    - 일정 시간마다 양 단말 애플리케이션의 세션 상태 정보를 체크하는 더미 패킷(Dummy Packet)을 보내는 기능을 추가
    - 패킷이 주기적으로 발생해 중간 방화벽에서 세션 타임아웃이 발생하기 전에 세션을 유지 
    - 최근 대부분의 플랫폼에서는 이런 기능들을 내장하고 개발하도록 안내
    - 중간 세션 장비의 세션 만료 시간으로 인한 문제를 해결하는 가장 바람직한 방법
  - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/205.jpg)

### 6.4.2 비대칭 경로 문제

- 네트워크의 안정성을 높이기 위해 네트워크 회선과 장비를 이중화
  - 이때 패킷이 지나가는 경로가 2개 이상이므로 인바운드 패킷과 아웃바운드 패킷의 경로가 같거나 다를 수 있다.
  -  인바운드 패킷과 아웃바운드 패킷이 같은 장비를 통과하는 것을 대칭 경로(Symmetric Path)
    - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/206.jpg)
  - 다른 장비를 통과하는 것을 비대칭 경로(Asymmetric Path)
    - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/206_2.jpg)
- 세션 장비는 세션 테이블을 만들어 관리해야 하므로 패킷이 들어오고 나갈 때 동일한 장비를 통과해야 한다.
  -  네트워크 경로 이중화를 위해 세션 장비를 두 대 이상 설치한 경우, 패킷이 들어올 때와 나갈 때 경로가 일정하게 유지되지 않으면 정상적인 서비스 X
- 2, 3계층 네트워크 장비는 세션 고려가 필요없어 네트워크 엔지니어 대다수가 세션 장비의 이런 특징을 파악X
  -  네트워크 효율성에만 초점을 맞추어 비대칭 경로를 사용하도록 네트워크를 디자인하는 경우 多
  - 이 문제의 가장 좋은 해결 방법은 비대칭 경로가 생기지 않도록 네트워크와 경로를 디자인하는 것
  - 세션 장비에 이런 비대칭 경로를 처리하는 기능을 이용할 수 있지만 
    - 이런 비대칭 패킷을 처리하기 위한 노력이 필요하여 세션 장비의 성능이 저하되거나 보안이 약화 가능성
- 처리방법
  - 세션 테이블을 동기화
    - 세션 테이블을 동기화하면 두 개 경로상의 두 장비가 하나의 장비처럼 동작하므로 비대칭 경로에서도 정상적으로 동작
    - 장점 
      - 패킷 경로를 변경하지 않고 동작
    - 단점
      - 세션을 동기화하는 시간보다 패킷 응답이 빠르면 정상적으로 동작하지 않을 수 있다
    - 데이터 센터에서 응답시간이 빠른 애플리케이션을 사용할 경우
      - 세션 동기화 시간보다 응답시간이 더 빠를 수 있으므로 이 기능을 사용하는 것을 추천 X
    - 응답시간이 비교적 긴 인터넷 게이트웨이로 방화벽이 사용될 때 유용하게 사용
    - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/207.jpg)
  - 비대칭 경로가 생길 경우, 세션 장비에서 다양한 방법으로 이를 보정
    -  인바운드 패킷이 통과하지 않았는데 아웃바운드 패킷이 장비로 들어온 경우 
      - 인바운드 패킷이 통과한 다른 세션 장비 쪽으로 패킷을 보내 경로를 보정
    - 강제로 다른 방화벽으로 패킷을 보내기 위해 
      - 방화벽 간 통신용 링크가 필요하고 MAC 주소를 변경하는 MAC 리라이팅(Rewriting)이나 기존 패킷에 MAC 주소를 한 번 더 인캡슐레이션하는 터널링(Tunneling) 기법으로 경로를 보
      - 세부 기술과 기술용어는 구현하는 회사마다 다르므로 도입한 장비가 지원하는 기능과 구현하는 방법은 제조사나 기술지원 인력을 통해 별도로 확인 필요

### 6.4.3 하나의 통신에 두 개 이상의 세션이 사용될 때의 고려사항

- 현대 프로토콜은 하나의 통신을 위해 한 개의 세션만 사용하는 경우가 대부분
  - 특별한 목적으로 두 개 이상의 세션을 만드는 경우 존재
  - 이때 서로 다른 두 세션이 하나의 통신을 위해 사용하고 있다는 것을 네트워크 통신 중간에 놓인 세션 장비도 파악해야 한다.
  - 두 통신 중 한쪽 세션이 끊겨 있거나 세션 장비의 세션 테이블에서 삭제되면 
    - 단방향 통신만 가능하거나 통신하지 못할 수 있음
    - 이런 경우 통신에 문제가 있음을 쉽게 파악하지 못하는 경우가 많아 장애가 길어질 수 있으니 더 주의
- 프로토콜은 데이터 프로토콜과 컨트롤 프로토콜로 구분
  - 데이터 프로토콜은 데이터를 실어 나르고 
  - 컨트롤 프로토콜은 데이터가 잘 전송되도록 세션을 제어
  - 현대 프로토콜들은 대부분 컨트롤 프로토콜 기능과 데이터 프로토콜 기능을 하나의 프로토콜에서 헤더나 별도 메시지로 해결
  - 특별한 목적이 있거나 오래된 프로토콜은 두 개의 프로토콜이 분리된 경우 존재
    - 가장 대표적인 프로토콜이 FTP(File Transfer Protocol)
    - FTP는 컨트롤 프로토콜과 데이터 프로토콜이 완전히 분리되어 있고 통신 방법이 다른 두 가지 모드를 가지고 있다.
    - FTP의 기본적인 구동 방식은 Active 모드
    - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/209.jpg)

- Active 모드
  - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/210.jpg)
  - 명령어를 전달하는 컨트롤 프로토콜과 데이터를 전달하는 데이터 프로토콜이 분리되어 있고 방향도 반대로 동작
  - 컨트롤 프로토콜은 클라이언트에서 서버로 통신을 시작하지만 데이터 프로토콜은 서버에서 클라이언트 쪽으로 데이터를 푸시
  - Active 모드를 사용할 때 중간에 방화벽이나 세션 장비가 있으면 Active 모드의 동작 방식에 맞추어 방화벽의 반대 방향도 열어야 한다. 
    - 특히 NAT 환경인 경우, FTP가 동작하는 프로토콜을 모두 이해할 수 있는 별도 기능을 동작
    - 이 기능을 ALG(Application Layer Gateway)라 한다. 
    - ALG가 동작하는 방화벽은 FTP 명령어를 이해하고 반대 방향으로 시작하는 데이터 세션을 인지해 방화벽과 NAT를 자동으로 동작시켜준다.
- Passive 모드
  - ![img](06_로드밸런서&방화벽_4계층장비(세션장비).assets/211.jpg)
  - Passive 모드는 Active 모드의 단점을 보완하기 위해 만들어짐. 
  - Active 모드의 가장 큰 문제는 컨트롤 프로토콜과 데이터 프로토콜의 방향이 반대라는 것
    - Passive 모드는 컨트롤, 데이터 프로토콜이 분리되어 있는 것은 같지만 클라이언트에서 서버쪽으로 데이터를 요청해 다운받도록 동작
  - Passive 모드에서 클라이언트 쪽에 방화벽이나 세션 장비가 있을 경우, 특별한 작업 없이 동작할 수 있다는 장점
    -  서버 쪽에 방화벽이 있으면 데이터 다운로드를 위한 추가 포트를 열어주어야 한다. 
    - FTP 서버에서 Passive 모드에서 사용하는 데이터 포트의 범위를 설정 가능